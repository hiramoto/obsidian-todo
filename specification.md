# Obsidian TaskChute Plugin 実装仕様書

## プラグイン概要

**プラグイン名**: TaskChute Work Logger（仮）

**目的**: Obsidianでタスク管理と作業時間記録を効率的に行うためのプラグイン

**対象プラットフォーム**: Desktop（Windows/Mac/Linux）および Mobile（iOS/Android）

---

## 前提知識：既存の運用方法

### Vault構成
```
vault/
├── 5-tasks/         # タスクファイル（1タスク1ファイル）
├── 2-daily/         # 日次ノート（予定 + 実績）
└── 0-dashboards/    # 集計用ページ
```

### タスクファイル構造
ファイル名: `YYYYMMDD-タスクタイトル.md`（例：`20260211-API実装.md`）

```yaml
---
task_id: 20260211-API実装
status: in-progress
created: 2026-02-11
review_date: 2026-02-18
due_date:
tags: [project/backend, type/implementation]
---

## 背景
なぜこのタスクが必要か

## 完了条件
どうなったらDoneとするか

## サブタスク
- [ ] エンドポイント設計
- [ ] 認証部分の実装

## 次の一手
次にやる最小ステップ

## メモ・気づき
作業中に気づいたこと
```

### 日次ノート構造
ファイル名: `YYYY-MM-DD.md`（例：`2026-02-11.md`）

```markdown
# 2026-02-11

## PLAN

# 08:00-10:00 120min 午前I
- [[20260211-設計ドキュメント作成]] / エンドポイント設計 60min
- [[20260211-レビュー対応]] 30min

# 10:00-12:00 120min 午前II
- [[20260211-API実装]] / 認証部分の実装 90min

---

## LOG

- 08:15-09:20 [[20260211-API実装]] / エンドポイント設計完了
- 09:30-10:05 [[20260211-レビュー対応]] / 3件レビュー完了
- 10:10-11:40 [[20260211-API実装]] / 認証部分実装途中

---

## メモ
その他気づきなど
```

### 重要なポイント
1. **実績（LOG）の記法**: `- HH:MM-HH:MM [[タスク名]] / メモ`
2. **予定（PLAN）の記法**: `- [[タスク名]] / サブタスク XXmin`
3. タスクファイル名とリンク名は一致（拡張子なし）
4. セクション名は設定可能にする（デフォルト: `PLAN`, `LOG`）

---

## Phase 1: 最小限の機能

### 1.1 タスクファイルに履歴を自動表示（View Plugin）

**機能概要**:
タスクファイル（`5-tasks/` フォルダ内）を開いたとき、ファイルの末尾に作業履歴セクションを自動挿入して表示する。

**実装詳細**:

#### 1.1.1 検出ロジック
- ファイルが `5-tasks/` フォルダ内にあるかチェック（フォルダ名は設定可能）
- ファイルのFrontmatterに `task_id` が存在するかチェック

#### 1.1.2 履歴の抽出ロジック
1. `2-daily/` フォルダ内のすべてのファイルを走査
2. 各ファイルから `## LOG` セクションを抽出
3. セクション内の行をパース：
   ```javascript
   const timeMatch = line.match(/(\d{2}):(\d{2})-(\d{2}):(\d{2})/);
   const taskMatch = line.match(/\[\[([^\]]+)\]\]/);
   const noteMatch = line.match(/\]\]\s*\/\s*(.+)$/);
   ```
4. タスク名が現在のファイル名（拡張子なし）と一致する行を抽出
5. 日付降順でソート

#### 1.1.3 表示形式
ファイルの末尾に以下の形式で挿入（実際のファイルは編集しない、View Pluginとして表示のみ）：

```markdown
---

## 作業履歴（自動生成）

| 日付 | 時刻 | 所要時間 | メモ |
|------|------|----------|------|
| [[2026-02-11]] | 08:15-09:20 | 1時間5分 | エンドポイント設計完了 |
| [[2026-02-10]] | 14:30-15:45 | 1時間15分 | 初期調査 |

**累計作業時間**: 2時間20分  
**作業日数**: 2日
```

#### 1.1.4 技術実装
- `MarkdownPostProcessorContext` を使用
- または `EditorExtension` でカスタムViewを追加
- ファイル内容は変更せず、読み取り専用のビューとして表示

---

### 1.2 ステータスバーに予定終了時刻を表示

**機能概要**:
Obsidianのステータスバー（画面下部）に、今日の予定終了時刻をリアルタイム表示する。

**実装詳細**:

#### 1.2.1 計算ロジック
1. 今日の日次ノート（`2-daily/YYYY-MM-DD.md`）を取得
2. `## PLAN` セクションから予定を抽出：
   ```javascript
   const timeMatch = line.match(/(\d+)min/);
   ```
3. 予定の総時間を計算
4. `## LOG` セクションから実績を抽出し、実績の総時間を計算
5. 残り時間 = 予定総時間 - 実績総時間
6. 最後の作業終了時刻を取得（LOGの最終行）
7. 予定終了時刻 = 最後の作業終了時刻 + 残り時間

#### 1.2.2 表示形式
ステータスバーに以下のように表示：

```
⏰ 予定終了: 17:30 (残り: 2時間15分)
```

残り時間がマイナスの場合：
```
✅ 予定完了 (+30分超過)
```

#### 1.2.3 更新タイミング
- 日次ノートを編集したとき
- ファイルを開いたとき
- 1分ごと（自動更新）

#### 1.2.4 技術実装
- `Plugin.addStatusBarItem()` を使用
- ファイル変更を `Vault.on('modify')` で監視
- `setInterval` で1分ごとに再計算

---

### 1.3 作業開始/終了のコマンド

**機能概要**:
コマンドパレットから作業の開始・終了を記録できるようにする。

#### 1.3.1 コマンド: 作業開始

**コマンド名**: `作業開始`

**動作**:
1. コマンドを実行
2. タスク選択UIを表示（モーダルまたはSuggester）
   - `5-tasks/` フォルダ内のファイル一覧を表示
   - `status: in-progress` のタスクを優先表示
   - インクリメンタル検索可能
3. タスクを選択
4. 開始時刻を記録（内部変数に保持）
5. 通知を表示：「タスク: XXX の作業を開始しました」

**技術実装**:
- `Plugin.addCommand()` でコマンド登録
- `SuggestModal` でタスク選択UI
- 開始時刻は `Plugin` のプロパティに保存

#### 1.3.2 コマンド: 作業終了

**コマンド名**: `作業終了`

**動作**:
1. コマンドを実行
2. 作業が開始されているかチェック
   - 開始されていない場合：エラー通知を表示
3. 終了時刻を取得
4. 所要時間を計算（分単位、5分刻みに丸める）
5. メモ入力UIを表示（オプション）
6. 今日の日次ノートを取得または作成
7. `## LOG` セクションに1行追加：
   ```
   - 開始時刻-終了時刻 [[タスク名]] / メモ
   ```
8. 通知を表示：「作業を記録しました（XX分）」

**技術実装**:
- `Plugin.addCommand()` でコマンド登録
- `TextInputModal` でメモ入力
- `Vault.modify()` または `Vault.append()` で日次ノートに追記
- セクションが存在しない場合は自動作成

#### 1.3.3 時刻の丸め処理
- 秒は5分刻みに丸める（例：08:17:42 → 08:20）
- 30秒未満：切り捨て
- 30秒以上：切り上げ

#### 1.3.4 エッジケース対応
- 日次ノートが存在しない場合：自動作成
- `## LOG` セクションが存在しない場合：自動挿入
- 作業開始中に別のタスクで作業開始した場合：警告表示

---

## Phase 2: 便利機能

### 2.1 サイドパネルで今日の集計表示

**機能概要**:
右サイドパネルに今日の作業時間集計をリアルタイム表示する。

**実装詳細**:

#### 2.1.1 表示内容
```
【今日の作業時間】

進捗状況
予定総時間: 6時間30分
実績時間: 3時間45分
残り時間: 2時間45分
⏰ 予定終了: 17:30

タスク別集計
─────────────────
API実装
  2回 / 1時間30分

レビュー対応
  1回 / 35分

設計ドキュメント作成
  1回 / 1時間5分
─────────────────
総作業時間: 3時間45分
```

#### 2.1.2 更新タイミング
- 日次ノートを編集したとき
- ファイルを開いたとき
- 1分ごと（自動更新）

#### 2.1.3 技術実装
- `ItemView` を継承してカスタムビューを作成
- `addRibbonIcon()` でサイドパネル開閉ボタンを追加
- HTMLで整形して表示

---

### 2.2 週次・月次集計ビュー

**機能概要**:
サイドパネルまたは別のビューで、週次・月次の集計を表示する。

**実装詳細**:

#### 2.2.1 表示内容
タブで切り替え可能：
- 今日
- 今週
- 先週
- 今月
- 先月

各タブで以下を表示：
```
【今週の作業時間】
2026-02-10 〜 2026-02-16

タスク別集計
─────────────────
API実装
  作業日数: 3日 / 5時間30分

レビュー対応
  作業日数: 2日 / 1時間45分
─────────────────
総作業時間: 12時間15分
1日平均: 2時間27分
```

#### 2.2.2 技術実装
- サイドパネルのビューを拡張
- タブUIは `setViewState()` で切り替え
- 集計ロジックはPhase 1と同様

---

### 2.3 設定画面（フォルダ名、セクション名）

**機能概要**:
プラグイン設定画面で、フォルダ名やセクション名をカスタマイズ可能にする。

**実装詳細**:

#### 2.3.1 設定項目

```typescript
interface PluginSettings {
    // フォルダ設定
    tasksFolder: string;        // デフォルト: "5-tasks"
    dailyFolder: string;        // デフォルト: "2-daily"
    
    // セクション名設定
    planSectionName: string;    // デフォルト: "PLAN"
    logSectionName: string;     // デフォルト: "LOG"
    
    // 日次ノート設定
    dailyNoteFormat: string;    // デフォルト: "YYYY-MM-DD"
    
    // 時刻丸め設定
    timeRoundingMinutes: number; // デフォルト: 5
    
    // 表示設定
    showStatusBar: boolean;     // デフォルト: true
    autoShowHistory: boolean;   // デフォルト: true
}
```

#### 2.3.2 設定画面UI
```
TaskChute Work Logger 設定

■ フォルダ設定
タスクフォルダ:     [5-tasks        ]
日次ノートフォルダ: [2-daily        ]

■ セクション名
予定セクション名:   [PLAN           ]
実績セクション名:   [LOG            ]

■ 日次ノート
ファイル名形式:     [YYYY-MM-DD     ]
  ※ moment.js形式で指定

■ 時刻設定
時刻丸め（分）:     [5              ]
  ※ 作業開始/終了時刻を指定分単位で丸めます

■ 表示設定
☑ ステータスバーに予定終了時刻を表示
☑ タスクファイルに作業履歴を自動表示
```

#### 2.3.3 技術実装
- `PluginSettingTab` を継承
- `addText()`, `addToggle()` でUI構築
- 設定変更時に `saveSettings()` で保存
- `data.json` に設定を保存

---

## 技術要件

### 開発環境
- **言語**: TypeScript
- **フレームワーク**: Obsidian Plugin API
- **ビルドツール**: esbuild（推奨）またはwebpack
- **Node.js**: v16以上

### 必須ファイル
```
plugin-root/
├── main.ts              # プラグインのエントリーポイント
├── manifest.json        # プラグイン情報
├── versions.json        # バージョン管理
├── styles.css           # スタイル（オプション）
├── tsconfig.json        # TypeScript設定
├── package.json         # 依存関係
└── .gitignore
```

### manifest.json
```json
{
    "id": "taskchute-work-logger",
    "name": "TaskChute Work Logger",
    "version": "1.0.0",
    "minAppVersion": "1.0.0",
    "description": "タスク管理と作業時間記録のためのプラグイン",
    "author": "Your Name",
    "authorUrl": "https://your-site.com",
    "isDesktopOnly": false
}
```

### 依存ライブラリ
- `obsidian`: Obsidian Plugin API
- `moment`: 日付処理（Obsidianに含まれている）

---

## 実装の優先順位

### Phase 1
1. **作業開始/終了コマンド**（最優先）
   - 理由：入力の手間を大幅に削減できる
   
2. **ステータスバー表示**
   - 理由：常に予定終了時刻が見えることで、時間管理がしやすくなる
   
3. **タスク履歴の自動表示**
   - 理由：DataviewJSのコピペが不要になる

### Phase 2
4. **サイドパネル集計**
5. **週次・月次集計**
6. **設定画面**

---

## モバイル対応の考慮点

### タッチ操作の最適化
- タスク選択UIは大きめのボタン/リスト
- スワイプジェスチャーは使わない（Obsidianの標準動作と競合）

### パフォーマンス
- ファイル走査は非同期で実行
- 大量のファイルがある場合はキャッシュを使用
- 重い処理は初回のみ実行、以降はキャッシュから取得

### UI調整
- ステータスバーの文字サイズを調整可能に
- サイドパネルの幅を狭くしても表示が崩れないように

---

## エラーハンドリング

### 想定されるエラーケース
1. フォルダが存在しない
   - 警告を表示し、フォルダ作成を提案
   
2. 日次ノートが存在しない
   - 自動作成（テンプレートがあれば使用）
   
3. セクションが存在しない
   - 自動挿入
   
4. ファイル名が想定と異なる
   - 設定画面のフォーマットに従う
   
5. タスクファイルのFrontmatterが不正
   - エラー通知を表示、処理をスキップ

---

## テスト項目

### Phase 1
- [ ] タスク履歴が正しく表示されるか
- [ ] 複数のタスクファイルで動作するか
- [ ] 日次ノートが複数ある場合も正しく集計できるか
- [ ] ステータスバーの時刻計算が正確か
- [ ] 作業開始コマンドでタスクが選択できるか
- [ ] 作業終了コマンドでLOGに正しく追記されるか
- [ ] 時刻が正しく丸められるか
- [ ] 日次ノートが存在しない場合でも動作するか

### Phase 2
- [ ] サイドパネルが正しく表示されるか
- [ ] リアルタイムで更新されるか
- [ ] 週次・月次の集計が正確か
- [ ] 設定画面で設定が保存・反映されるか

---

## 参考資料

### Obsidian Plugin API
- 公式ドキュメント: https://docs.obsidian.md/Plugins/Getting+started/Build+a+plugin
- サンプルプラグイン: https://github.com/obsidianmd/obsidian-sample-plugin
- API Reference: https://docs.obsidian.md/Reference/TypeScript+API/Plugin

### 類似プラグイン（参考）
- Dataview: ファイル走査とクエリ処理の参考
- Templater: コマンド実装の参考
- Tasks: タスク管理UIの参考

---

## 補足情報

### 既存のDataviewJSクエリ（参考）

現在、以下のようなDataviewJSを手動で書いている：

```javascript
// タスク履歴表示
const currentTaskName = dv.current().file.name.replace('.md', '');
const dailyFiles = dv.pages('"2-daily"');

const workLogs = [];

for (let file of dailyFiles) {
    const content = await dv.io.load(file.file.path);
    const lines = content.split('\n');
    let inResultSection = false;
    
    for (let line of lines) {
        if (line.trim() === '## LOG') {
            inResultSection = true;
            continue;
        }
        
        if (inResultSection && line.startsWith('##')) {
            break;
        }
        
        if (inResultSection && line.trim().startsWith('-')) {
            const timeMatch = line.match(/(\d{2}):(\d{2})-(\d{2}):(\d{2})/);
            const taskMatch = line.match(/\[\[([^\]]+)\]\]/);
            const noteMatch = line.match(/\]\]\s*\/\s*(.+)$/);
            
            if (timeMatch && taskMatch && taskMatch[1] === currentTaskName) {
                // ... 処理
            }
        }
    }
}
```

このロジックをプラグイン内で再利用すること。

---

## 開発の進め方（推奨）

### ステップ1: 環境構築
1. Obsidian Sample Pluginをクローン
2. プラグインIDとmanifestを書き換え
3. ローカルVaultの `.obsidian/plugins/` にシンボリックリンク作成
4. `npm run dev` で開発モード起動

### ステップ2: Phase 1-3（作業開始/終了コマンド）
- 最も価値が高く、実装も比較的簡単
- まずはデスクトップで動作確認
- モバイルテストは後回しでOK

### ステップ3: Phase 1-2（ステータスバー）
- タイマー処理に注意
- メモリリーク対策（`unload()` で `clearInterval`）

### ステップ4: Phase 1-1（履歴表示）
- View Pluginの実装が必要
- Obsidian APIドキュメントをよく読むこと

### ステップ5: Phase 2
- 基本機能が安定してから着手

---

## その他の注意事項

### パフォーマンス
- 大量のファイル（1000+）がある場合を想定
- ファイル走査は初回のみ、以降はキャッシュを活用
- `Vault.on('modify')` で変更があったファイルのみ再処理

### セキュリティ
- ユーザーのファイルを直接編集する機能（作業終了コマンド）は慎重に実装
- バックアップ機能は不要（Obsidian本体が管理）

### ユーザビリティ
- 通知は控えめに（エラー時と重要な操作時のみ）
- 設定のデフォルト値は現在の運用方法に合わせる

---

以上の仕様書を元に、プラグインを実装してください。
不明点があれば、Obsidian Plugin APIのドキュメントを参照するか、既存のプラグインのソースコードを確認してください。
